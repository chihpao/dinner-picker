import{b as S,u as _,c as y}from"./D8w1TNDh.js";const P=()=>{const v="dinnerPicker.accounts.v1",p="dinnerPicker.accounts.pending",l="accounts",u=S(),{user:s}=_(),n=y("accounts",()=>[]),m=y("accounts-loading",()=>!1),A=()=>{try{const t=localStorage.getItem(v),r=t?JSON.parse(t):[];return Array.isArray(r)?r.filter(e=>e.user_id===s.value?.id):[]}catch(t){return console.error("Failed to parse local accounts",t),[]}},i=t=>{try{const r=localStorage.getItem(v),e=r?JSON.parse(r):[],a=Array.isArray(e)?e.filter(c=>c.user_id!==s.value?.id):[];localStorage.setItem(v,JSON.stringify([...a,...t]))}catch(r){console.error("Failed to save local accounts",r)}},d=()=>{try{const t=localStorage.getItem(p),r=t?JSON.parse(t):[];return Array.isArray(r)?r.filter(e=>e.user_id===s.value?.id):[]}catch(t){return console.error("Failed to parse pending accounts",t),[]}},f=t=>{try{const r=localStorage.getItem(p),e=r?JSON.parse(r):[],a=Array.isArray(e)?e.filter(c=>c.user_id!==s.value?.id):[];localStorage.setItem(p,JSON.stringify([...a,...t]))}catch(r){console.error("Failed to save pending accounts",r)}},h=async()=>{if(!s.value)return[];m.value=!0;const{data:t,error:r}=await u.from(l).select("*").eq("user_id",s.value.id).order("created_at",{ascending:!1});if(m.value=!1,r)throw r;return(t??[]).map(e=>({id:e.id,name:e.name,kind:e.kind??"bank",balance:e.balance??0,createdAt:e.created_at?new Date(e.created_at).getTime():Date.now(),user_id:e.user_id}))},w=async()=>{if(!s.value)return;const t=d();if(!t.length)return;const r=[];for(const e of t)try{const a={id:e.id,name:e.name,kind:e.kind,balance:e.balance??0,created_at:new Date(e.createdAt).toISOString(),user_id:s.value.id},{error:c}=await u.from(l).insert(a);if(c)throw c}catch(a){console.error("Retry pending accounts failed",a),r.push(e)}f(r)};return{accounts:n,loading:m,loadAccounts:async()=>{if(!s.value){n.value=[];return}try{await w()}catch(t){console.error("sync pending accounts failed",t)}try{const t=await h(),r=d(),e=new Set(t.map(a=>a.id));n.value=[...r.filter(a=>!e.has(a.id)),...t],i(n.value)}catch(t){console.error("Supabase read failed for accounts, using local",t);const r=A(),e=d(),a=new Set(r.map(c=>c.id));n.value=[...e.filter(c=>!a.has(c.id)),...r]}},addAccount:async t=>{if(!s.value)return;const r=d();r.unshift(t),f(r),n.value.unshift(t),i(n.value);try{const e={id:t.id,name:t.name,kind:t.kind,balance:t.balance??0,created_at:new Date(t.createdAt).toISOString(),user_id:s.value.id},{error:a}=await u.from(l).insert(e);if(a)throw a;const c=d().filter(g=>g.id!==t.id);f(c)}catch(e){console.warn("Cloud sync failed for accounts, kept in pending",e)}},updateAccount:async t=>{if(!s.value)return;const r=n.value.find(o=>o.id===t.id);if(!r)return;const e={...r,...t,user_id:s.value.id},a=[...n.value];n.value=n.value.map(o=>o.id===e.id?e:o),i(n.value);const c=d(),g=c.findIndex(o=>o.id===e.id);if(g!==-1){c[g]=e,f(c);return}try{const{error:o}=await u.from(l).update({name:e.name,kind:e.kind,balance:e.balance??0}).eq("id",e.id).eq("user_id",s.value.id);if(o)throw o}catch(o){n.value=a,i(a),alert(`更新帳戶失敗：${o.message}`)}},deleteAccount:async t=>{if(!s.value)return;const r=[...n.value];n.value=n.value.filter(e=>e.id!==t),i(n.value);try{const{error:e}=await u.from(l).delete().eq("id",t).eq("user_id",s.value.id);if(e)throw e}catch(e){n.value=r,i(r),alert(`刪除帳戶失敗：${e.message}`)}}}};export{P as u};
