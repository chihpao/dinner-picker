import{b as M,u as z,t as G,s as R,p as B,i as W}from"./BjSyBa9A.js";import{C as A,k as b}from"./B6HfJZvd.js";const j={total:{storageKey:"dinnerPicker.total.expenses.v1",pendingKey:"dinnerPicker.total.expenses.pending",table:"total_expenses",statePrefix:"total-expense",includeAccount:!0}},H=(D="total")=>{const c=j[D],w=c.storageKey,_=c.pendingKey,g=c.table,f=M(),{user:s}=z(),o=A(`${c.statePrefix}-entries`,()=>[]),S=A(`${c.statePrefix}-loading`,()=>!1),P=()=>{try{const e=localStorage.getItem(w),a=e?JSON.parse(e):[];return Array.isArray(a)?a.filter(t=>t.user_id===s.value?.id):[]}catch(e){return console.error("Failed to parse local entries",e),[]}},p=e=>{try{const a=localStorage.getItem(w),t=a?JSON.parse(a):[],n=Array.isArray(t)?t.filter(r=>r.user_id!==s.value?.id):[];localStorage.setItem(w,JSON.stringify([...n,...e]))}catch(a){console.error("Failed to save local entries",a)}},l=()=>{try{const e=localStorage.getItem(_),a=e?JSON.parse(e):[];return Array.isArray(a)?a.filter(t=>t.user_id===s.value?.id):[]}catch(e){return console.error("Failed to parse pending entries",e),[]}},m=e=>{try{const a=localStorage.getItem(_),t=a?JSON.parse(a):[],n=Array.isArray(t)?t.filter(r=>r.user_id!==s.value?.id):[];localStorage.setItem(_,JSON.stringify([...n,...e]))}catch(a){console.error("Failed to save pending entries",a)}},O=async()=>{if(!s.value)return[];S.value=!0;const{data:e,error:a}=await f.from(g).select("*").eq("user_id",s.value.id).order("date",{ascending:!1}).order("created_at",{ascending:!1});if(S.value=!1,a)throw a;return(e??[]).map(t=>({id:t.id,date:t.date,amount:t.amount,note:t.note??"",createdAt:t.created_at?new Date(t.created_at).getTime():Date.now(),user_id:t.user_id,account_id:t.account_id??null,sub_type:t.sub_type??"general"}))},k=async()=>{if(!s.value)return;const e=l();if(!e.length)return;const a=[];for(const t of e)try{const n={id:t.id,date:t.date,amount:t.amount,note:t.note??"",created_at:new Date(t.createdAt).toISOString(),user_id:s.value.id,sub_type:t.sub_type??"general",...c.includeAccount?{account_id:t.account_id??null}:{}},{error:r}=await f.from(g).insert(n);if(r)throw r}catch(n){console.error("Retry pending failed",n),a.push(t)}m(a)},F=async()=>{if(!s.value){o.value=[];return}try{await k()}catch(e){console.error("sync pending failed",e)}try{const e=await O(),a=l(),t=new Set(e.map(n=>n.id));o.value=[...a.filter(n=>!t.has(n.id)),...e],p(o.value)}catch(e){console.error("Supabase read failed, using local",e);const a=P(),t=l(),n=new Set(a.map(r=>r.id));o.value=[...t.filter(r=>!n.has(r.id)),...a]}},N=async e=>{if(!s.value)return;const a=l();a.unshift(e),m(a),o.value.unshift(e),p(o.value);try{const t={id:e.id,date:e.date,amount:e.amount,note:e.note??"",created_at:new Date(e.createdAt).toISOString(),user_id:s.value.id,sub_type:e.sub_type??"general",...c.includeAccount?{account_id:e.account_id??null}:{}},{error:n}=await f.from(g).insert(t);if(n)throw n;const r=l().filter(v=>v.id!==e.id);m(r)}catch(t){console.warn("Cloud sync failed, kept in pending",t)}},$=async e=>{if(s.value)try{const{error:a}=await f.from(g).delete().eq("id",e).eq("user_id",s.value.id);if(a)throw a;o.value=o.value.filter(r=>r.id!==e),p(o.value);const t=l(),n=t.filter(r=>r.id!==e);n.length!==t.length&&m(n)}catch(a){alert(`刪除失敗：${a.message}`)}},q=async e=>{if(!s.value)return;const a=o.value.find(i=>i.id===e.id);if(!a)return;const t={...a,...e,user_id:s.value.id},n=[...o.value];o.value=o.value.map(i=>i.id===t.id?t:i),p(o.value);const r=l(),v=r.findIndex(i=>i.id===t.id);if(v!==-1){r[v]=t,m(r);return}try{const{error:i}=await f.from(g).update({date:t.date,amount:t.amount,note:t.note??"",sub_type:t.sub_type??"general",...c.includeAccount?{account_id:t.account_id??null}:{}}).eq("id",t.id).eq("user_id",s.value.id);if(i)throw i}catch(i){o.value=n,p(n),alert(`更新失敗：${i.message}`)}},J=async()=>{if(s.value)try{const{error:e}=await f.from(g).delete().eq("user_id",s.value.id);if(e)throw e;o.value=[],p([]),m([])}catch(e){alert(`清空失敗：${e.message}`)}},x=e=>{const a=new Date;G(a);const t=R(a),n=new Date(t);n.setDate(n.getDate()+7);const r=new Date(a.getFullYear(),a.getMonth(),1),v=new Date(a.getFullYear(),a.getMonth()+1,1),i=new Date(a.getFullYear(),0,1),T=new Date(a.getFullYear()+1,0,1),C={today:0,todayExpense:0,todayIncome:0,week:0,weekExpense:0,weekIncome:0,month:0,monthExpense:0,monthIncome:0,year:0,yearExpense:0,yearIncome:0};return o.value.reduce((y,u)=>{if(u.note&&u.note.includes("[轉帳]")||e&&!e(u))return y;const d=B(u.date),L=u.amount<0,I=Math.abs(u.amount),h=E=>{y[E]+=u.amount,L?y[`${E}Income`]+=I:y[`${E}Expense`]+=I};return W(d,a)&&h("today"),d>=t&&d<n&&h("week"),d>=r&&d<v&&h("month"),d>=i&&d<T&&h("year"),y},C)},K=b(()=>x()),Y=b(()=>x(e=>e.sub_type==="zibao"));return{entries:o,loading:S,summaries:K,zibaoSummaries:Y,loadEntries:F,addEntry:N,deleteEntry:$,updateEntry:q,clearAll:J}},V=()=>H("total");export{V as u};
